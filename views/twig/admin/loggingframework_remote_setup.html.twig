<!DOCTYPE html>
<html>
<head>
    <title>Remote - Setup</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #fff; }
        h1 { margin: 0 0 10px 0; font-size: 18px; color: #333; display: flex; align-items: center; gap: 15px; }
        .component-status { display: inline-flex; align-items: center; gap: 8px; font-size: 12px; padding: 4px 10px; border-radius: 12px; }
        .component-status.active { background: #e8f5e9; color: #2e7d32; }
        .component-status.inactive { background: #f5f5f5; color: #9e9e9e; }
        .component-status.blocked { background: #ffebee; color: #c62828; }
        .toggle-section { margin-bottom: 25px; padding: 15px; background: #f0f7ff; border: 1px solid #2196f3; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; }
        .toggle-section h3 { margin: 0; font-size: 14px; color: #1976d2; }
        .toggle-section.disabled { background: #f5f5f5; border-color: #ccc; opacity: 0.6; }
        .toggle-section.disabled h3 { color: #999; }
        .toggle-switch { position: relative; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 26px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        .toggle-slider.disabled { cursor: not-allowed; }
        input:checked + .toggle-slider { background-color: #4caf50; }
        input:checked + .toggle-slider:before { transform: translateX(24px); }
        .block-notice { padding: 20px; background: #ffebee; border: 2px solid #ef5350; border-radius: 4px; margin-bottom: 20px; }
        .block-notice h3 { color: #c62828; margin: 0 0 10px 0; }
        .block-notice p { color: #c62828; margin: 0 0 15px 0; }
        .block-notice a { color: #1976d2; text-decoration: underline; }
        .ready-notice { padding: 15px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; margin-bottom: 20px; }
        .ready-notice h3 { color: #2e7d32; margin: 0 0 5px 0; }
        .ready-notice p { color: #2e7d32; margin: 0; }
        .prerequisite-notice { padding: 15px; background: #fff3e0; border: 1px solid #ff9800; border-radius: 4px; margin-bottom: 20px; }
        .prerequisite-notice h3 { color: #e65100; margin: 0 0 10px 0; }
        .prerequisite-notice p { color: #e65100; margin: 0; }
        .prerequisite-notice code { background: #fff; padding: 2px 6px; border-radius: 3px; font-size: 12px; }
    </style>
</head>
<body>

{% set isActive = oView.isComponentActive() %}
{% set apiUserSetupComplete = oView.isApiUserSetupComplete() %}
{% set configAccessActivated = oView.isConfigAccessActivated() %}

<h1>
    {{ translate({ ident: "OXSREQUESTLOGGER_LF_REMOTE_TITLE" }) }}
    {% if not apiUserSetupComplete %}
        <span class="component-status blocked">
            {{ translate({ ident: "OXSLOGGINGFRAMEWORK_REMOTE_STATUS_BLOCKED" }) }}
        </span>
    {% else %}
        <span class="component-status {{ isActive ? 'active' : 'inactive' }}">
            {{ isActive ? translate({ ident: "OXSREQUESTLOGGER_LF_STATUS_ACTIVE" }) : translate({ ident: "OXSREQUESTLOGGER_LF_STATUS_INACTIVE" }) }}
        </span>
    {% endif %}
</h1>
<p style="color: #666; margin-bottom: 20px;">{{ translate({ ident: "OXSREQUESTLOGGER_LF_REMOTE_DESC" }) }}</p>

{% if not apiUserSetupComplete %}
    {# Hard-Block: API User not set up #}
    <div class="block-notice">
        <h3>&#9888; {{ translate({ ident: "OXSLOGGINGFRAMEWORK_REMOTE_BLOCKED_TITLE" }) }}</h3>
        <p>{{ translate({ ident: "OXSLOGGINGFRAMEWORK_REMOTE_BLOCKED_TEXT" }) }}</p>
        <p><a href="javascript:top.basefrm.location='{{ oViewConf.getSelfLink()|replace({"&amp;": "&"})|raw }}&cl=loggingframework_apiuser_setup';">&#8594; {{ translate({ ident: "OXSLOGGINGFRAMEWORK_REMOTE_GOTO_APIUSER" }) }}</a></p>
    </div>
{% else %}
    {# API User is set up - show component controls #}

    {% if not configAccessActivated %}
        <div class="prerequisite-notice">
            <h3>&#9888; {{ translate({ ident: "OXSLOGGINGFRAMEWORK_REMOTE_CONFIG_ACCESS_REQUIRED_TITLE" }) }}</h3>
            <p>{{ translate({ ident: "OXSLOGGINGFRAMEWORK_REMOTE_CONFIG_ACCESS_REQUIRED_TEXT" }) }}</p>
            <p style="margin-top: 10px;"><code>./vendor/bin/oe-console oe:module:activate oe_graphql_configuration_access</code></p>
        </div>
    {% endif %}

    <form method="post" action="{{ oViewConf.getSelfLink()|raw }}" id="toggleForm" target="_self">
        {{ oViewConf.getHiddenSid()|raw }}
        <input type="hidden" name="cl" value="loggingframework_remote_setup">
        <input type="hidden" name="fnc" value="toggleComponent">
        <input type="hidden" name="reloadFrame" value="1">
    </form>

    <div class="toggle-section {{ not configAccessActivated ? 'disabled' : '' }}">
        <div>
            <h3>{{ translate({ ident: "OXSREQUESTLOGGER_LF_COMPONENT_ACTIVATION" }) }}</h3>
            <small style="color: #666;">{{ translate({ ident: "OXSREQUESTLOGGER_LF_COMPONENT_ACTIVATION_DESC" }) }}</small>
        </div>
        <label class="toggle-switch">
            <input type="checkbox" {{ isActive ? 'checked' : '' }} {{ not configAccessActivated ? 'disabled' : '' }} onchange="submitToggleAndReload();">
            <span class="toggle-slider {{ not configAccessActivated ? 'disabled' : '' }}"></span>
        </label>
    </div>

    {% if isActive and configAccessActivated %}
        <div class="ready-notice">
            <h3>&#10004; {{ translate({ ident: "OXSLOGGINGFRAMEWORK_REMOTE_READY_TITLE" }) }}</h3>
            <p>{{ translate({ ident: "OXSLOGGINGFRAMEWORK_REMOTE_READY_TEXT" }) }}</p>
        </div>
    {% endif %}

    <script>
    function submitToggleAndReload() {
        {% if not configAccessActivated %}
        return false;
        {% endif %}
        var form = document.getElementById('toggleForm');
        var xhr = new XMLHttpRequest();
        xhr.open('POST', form.action, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (top.localStorage) {
                    top.localStorage.setItem('oxs_lf_expand_nav', 'loggingframework_remote_setup');
                }
                top.location.reload();
            }
        };
        var formData = new FormData(form);
        var params = new URLSearchParams(formData).toString();
        xhr.send(params);
    }
    </script>
{% endif %}

</body>
</html>
